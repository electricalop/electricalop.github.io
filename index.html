<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Railway Crew Resource Hub</title>
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Configure PDF.js worker
    window['pdfjs-dist/build/pdf'] = pdfjsLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>
  <script src="js/pdf-thumbnail.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f5f5f5; }
    #app { display: flex; flex-direction: column; min-height: 100vh; }

    header {
      background: #2e7d32;
      color: white;
      padding: 1rem;
      text-align: center;
    }

    main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    aside {
      width: 250px;
      background: #fff;
      border-right: 1px solid #ddd;
      padding: 1rem;
      overflow-y: auto;
    }

    aside ul {
      list-style: none;
      padding: 0;
    }

    aside li {
      margin: 6px 0;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    aside li:hover, aside li.active {
      background-color: #e0f2f1;
    }

    section {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }

    .search input {
      width: 100%;
      padding: 10px;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .card {
      background: white;
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .thumbnail-container {
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
      background: #f5f5f5;
      border-radius: 6px;
      position: relative;
    }

    .loading-thumbnail {
      font-size: 12px;
      color: #666;
      text-align: center;
    }

    .card img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
    }

    .card-content {
      flex: 1;
    }

    .card h4 {
      margin: 0 0 10px 0;
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 5px;
      text-decoration: none;
      font-weight: bold;
      font-size: 14px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s ease;
    }

    .btn-view {
      background-color: #2e7d32;
      color: white;
    }

    .btn-view:hover {
      background-color: #1b5e20;
    }

    .btn-download {
      background-color: #1976d2;
      color: white;
    }

    .btn-download:hover {
      background-color: #1565c0;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .thumbnail-loading {
      opacity: 0.5;
      filter: blur(1px);
    }

    /* FIXED: Proper Modal Scrolling for All Mobile Browsers */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      /* CRITICAL: Allow scrolling in overlay */
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      /* Center content but allow scroll */
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 20px 0;
      box-sizing: border-box;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      width: 90vw;
      max-width: 800px;
      /* FIXED: Remove fixed height, let content determine height */
      min-height: 300px;
      max-height: none;
      position: relative;
      display: flex;
      flex-direction: column;
      /* Allow content to expand naturally */
      margin: auto;
    }

    .modal-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      background: white;
      border-radius: 8px 8px 0 0;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.1em;
      color: #333;
      word-break: break-word;
    }

    .modal-body {
      /* FIXED: Remove overflow hidden, let content flow naturally */
      padding: 0;
      position: relative;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      padding: 4px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .close-btn:hover {
      color: #000;
      background: #f5f5f5;
    }

    .modal-image,
    .modal-video {
      max-width: 100%;
      max-height: 70vh;
      display: block;
      margin: 0 auto;
      padding: 1rem;
    }

    .modal-audio {
      width: 100%;
      padding: 1rem;
    }

    /* FIXED: Better PDF Options Layout */
    .mobile-pdf-options {
      padding: 1.5rem;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      /* Let it expand naturally */
      min-height: auto;
      box-sizing: border-box;
    }

    .mobile-pdf-options h4 {
      margin: 0 0 1rem 0;
      color: #333;
      font-size: 1.2em;
      text-align: center;
    }

    .mobile-pdf-options > p {
      margin: 0 0 1.5rem 0;
      color: #666;
      line-height: 1.4;
      text-align: center;
    }

    .option-card {
      margin: 0 0 1.5rem 0;
      padding: 1.5rem;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .option-card:last-of-type {
      margin-bottom: 1rem;
    }

    .option-card h5 {
      margin: 0 0 0.8rem 0;
      color: #2e7d32;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .option-card p {
      margin: 0 0 1rem 0;
      font-size: 14px;
      color: #555;
      text-align: left;
      line-height: 1.4;
    }

    .option-card .btn {
      margin: 0.25rem;
      min-width: 140px;
    }

    .recommended-badge {
      background: #4caf50;
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 12px;
      white-space: nowrap;
    }

    .info-box {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      color: #1565c0;
      padding: 1rem;
      margin: 1rem 0 2rem 0;
      border-radius: 6px;
      font-size: 13px;
      text-align: left;
      line-height: 1.4;
    }

    .info-box strong {
      display: block;
      margin-bottom: 8px;
      color: #0d47a1;
    }

    .button-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* MOBILE SPECIFIC FIXES */
    @media (max-width: 768px) {
      main {
        flex-direction: column;
      }

      aside {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #ddd;
      }

      .actions {
        flex-direction: column;
      }

      .btn {
        text-align: center;
        justify-content: center;
      }

      /* CRITICAL: Mobile Modal Fixes */
      .modal-overlay {
        padding: 10px 0;
        align-items: flex-start;
      }

      .modal-content {
        width: 95vw;
        margin: 0 auto;
        /* Ensure proper mobile spacing */
        min-height: auto;
      }

      .modal-header {
        padding: 1rem;
        position: sticky;
        top: 0;
      }

      .modal-header h3 {
        font-size: 1em;
      }

      .mobile-pdf-options {
        padding: 1rem;
      }

      .option-card {
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .option-card .btn {
        min-width: 120px;
        font-size: 12px;
        padding: 8px 12px;
        margin: 0.2rem;
      }

      .button-group {
        gap: 4px;
      }

      .recommended-badge {
        font-size: 10px;
        padding: 1px 6px;
      }
    }

    @media (max-width: 480px) {
      .modal-overlay {
        padding: 5px 0;
      }
      
      .modal-content {
        width: 98vw;
      }

      .modal-header {
        padding: 0.75rem;
      }

      .mobile-pdf-options {
        padding: 0.75rem;
      }

      .option-card {
        padding: 1rem 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>Railway Crew Resource Hub</h1>
    </header>
    <main>
      <aside>
        <h3>File Types</h3>
        <ul>
          <li :class="{active: selectedCategory === 'All'}" @click="selectCategory('All')">All</li>
          <li v-for="cat in categories" :key="cat"
              :class="{active: selectedCategory === cat}"
              @click="selectCategory(cat)">
            {{ cat.charAt(0).toUpperCase() + cat.slice(1) }}
          </li>
        </ul>
      </aside>
      <section>
        <input v-model="searchText" placeholder="Search files..." />
        <div v-if="filteredFiles.length === 0">No files found.</div>
        <div v-for="file in filteredFiles" :key="file.file" class="card">
          <div class="thumbnail-container">
            <template v-if="file.type === 'pdf'">
              <img 
                v-if="file.pdfThumbnail" 
                :src="file.pdfThumbnail" 
                alt="PDF Thumbnail"
              />
              <div v-else-if="file.loadingThumbnail" class="loading-thumbnail">
                Loading PDF...
              </div>
              <img 
                v-else 
                :src="file.thumbnail" 
                alt="Default PDF Thumbnail"
                :class="{ 'thumbnail-loading': file.thumbnailGenerationStarted }"
              />
            </template>
            <img 
              v-else 
              :src="file.thumbnail" 
              alt="Thumbnail"
            />
          </div>
          <div class="card-content">
            <h4>{{ file.title }}</h4>
            <div class="actions">
              <button class="btn btn-view" @click="viewFile(file)">
                👁️ View
              </button>
              <button class="btn btn-download" @click="downloadFile(file)">
                📥 Download
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- FIXED Modal -->
    <div v-if="viewingFile" class="modal-overlay" @click="closeModal">
      <div class="modal-content" @click.stop>
        <div class="modal-header">
          <h3>{{ viewingFile.title }}</h3>
          <button class="close-btn" @click="closeModal">&times;</button>
        </div>
        <div class="modal-body">
          <div v-if="viewingFile.type === 'pdf'" class="mobile-pdf-options">
            <h4>📱 Mobile PDF Viewing</h4>
            <p>Choose the best viewing method for your Android device:</p>
            
            <div class="option-card">
              <h5>
                🚀 Instant Access 
                <span class="recommended-badge">RECOMMENDED</span>
              </h5>
              <p>Open directly in your device's default PDF app or browser. Works reliably on all Android browsers including Chrome and Opera GX.</p>
              <div class="button-group">
                <button class="btn btn-view" @click="openInNewTab(viewingFile.file)">
                  🔗 Open in New Tab
                </button>
                <button class="btn btn-download" @click="downloadAndClose(viewingFile)">
                  📥 Download PDF
                </button>
              </div>
            </div>

            <div class="option-card">
              <h5>🔧 Alternative Viewers</h5>
              <p>These may work but can fail on mobile browsers (like the face icon or error you experienced).</p>
              <div class="button-group">
                <button class="btn btn-view" @click="tryMozillaViewer">
                  🦊 Mozilla PDF.js
                </button>
                <button class="btn btn-view" @click="tryDirectView">
                  📋 Direct Browser View
                </button>
              </div>
            </div>
            
            <div class="info-box">
              <strong>📱 Why Google Viewer Fails on Android:</strong>
              Google Docs Viewer has known issues with mobile browsers, especially Android Chrome and Opera GX. It frequently returns empty responses (204 errors) or shows placeholder icons instead of PDF content. This is a long-standing, unfixed issue with Google's service.
            </div>
          </div>
          
          <img 
            v-else-if="viewingFile.type === 'image'"
            :src="viewingFile.file"
            :alt="viewingFile.title"
            class="modal-image"
          />
          
          <video 
            v-else-if="viewingFile.type === 'video'"
            :src="viewingFile.file"
            controls
            class="modal-video"
          >
            Your browser does not support the video tag.
          </video>
          
          <audio 
            v-else-if="viewingFile.type === 'audio'"
            :src="viewingFile.file"
            controls
            class="modal-audio"
          >
            Your browser does not support the audio element.
          </audio>
        </div>
      </div>
    </div>
  </div>

  <!-- FIXED Vue Script -->
  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          files: [],
          selectedCategory: 'All',
          searchText: '',
          processedPdfs: new Set(),
          viewingFile: null
        };
      },
      computed: {
        categories() {
          return [...new Set(this.files.map(f => f.category))].sort();
        },
        filteredFiles() {
          const filtered = this.files.filter(f => {
            const matchCat = this.selectedCategory === 'All' || f.category === this.selectedCategory;
            const matchText = f.title.toLowerCase().includes(this.searchText.toLowerCase());
            return matchCat && matchText;
          });

          this.$nextTick(() => {
            filtered.forEach(file => {
              if (file.type === 'pdf' && 
                  !file.pdfThumbnail && 
                  !file.loadingThumbnail && 
                  !this.processedPdfs.has(file.file)) {
                this.loadPDFThumbnail(file);
              }
            });
          });

          return filtered;
        }
      },
      methods: {
        selectCategory(cat) {
          this.selectedCategory = cat;
        },
        async loadFiles() {
          try {
            const response = await fetch('data/docs.json');
            this.files = await response.json();
            
            this.files.forEach(file => {
              if (file.type === 'pdf') {
                this.$set(file, 'pdfThumbnail', null);
                this.$set(file, 'loadingThumbnail', false);
                this.$set(file, 'thumbnailGenerationStarted', false);
              }
            });
          } catch (err) {
            console.error('Could not load docs.json:', err);
          }
        },
        async loadPDFThumbnail(file) {
          if (file.type === 'pdf' && 
              !file.pdfThumbnail && 
              !file.loadingThumbnail && 
              !this.processedPdfs.has(file.file)) {
            
            this.processedPdfs.add(file.file);
            file.loadingThumbnail = true;
            file.thumbnailGenerationStarted = true;
            
            try {
              const thumbnail = await generatePDFThumbnail(file.file);
              if (thumbnail) {
                file.pdfThumbnail = thumbnail;
              }
            } catch (error) {
              console.error('Failed to load PDF thumbnail for', file.file, ':', error);
            } finally {
              file.loadingThumbnail = false;
            }
          }
        },
        viewFile(file) {
          this.viewingFile = file;
          document.body.style.overflow = 'hidden';
        },
        openInNewTab(fileUrl) {
          window.open(fileUrl, '_blank');
        },
        tryMozillaViewer() {
          const fullUrl = new URL(this.viewingFile.file, window.location.origin).href;
          const viewerUrl = `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(fullUrl)}`;
          window.open(viewerUrl, '_blank');
        },
        tryDirectView() {
          window.open(this.viewingFile.file, '_blank');
        },
        downloadAndClose(file) {
          this.downloadFile(file);
          this.closeModal();
        },
        closeModal() {
          this.viewingFile = null;
          document.body.style.overflow = '';
        },
        async downloadFile(file) {
          try {
            const response = await fetch(file.file);
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const fileName = this.getFileName(file.file);
            
            const tempLink = document.createElement('a');
            tempLink.href = url;
            tempLink.download = fileName;
            tempLink.style.display = 'none';
            
            document.body.appendChild(tempLink);
            tempLink.click();
            document.body.removeChild(tempLink);
            
            window.URL.revokeObjectURL(url);
            
          } catch (error) {
            console.error('Download failed:', error);
            const tempLink = document.createElement('a');
            tempLink.href = file.file;
            tempLink.download = this.getFileName(file.file);
            tempLink.style.display = 'none';
            document.body.appendChild(tempLink);
            tempLink.click();
            document.body.removeChild(tempLink);
          }
        },
        getFileName(filePath) {
          return filePath.split('/').pop();  // FIXED: Added missing closing parenthesis
        }
      },
      mounted() {
        this.loadFiles();
        
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.viewingFile) {
            this.closeModal();
          }
        });
      }
    }).mount('#app');
  </script>
</body>
</html>
