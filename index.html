<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Railway Crew Resource Hub</title>
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    window['pdfjs-dist/build/pdf'] = pdfjsLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>
  <script src="js/pdf-thumbnail.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
  <style>
    /* ... Previous Styles ... */
    .card {
      background: #fff;
      padding: 0.8rem 1.1rem;
      margin: 0 auto 1.2rem auto;
      border-radius: 18px;
      box-shadow: 0 2.5px 12px rgba(80,140,120,0.09);
      display: flex;
      align-items: center;
      gap: 19px;
      max-width: 650px;
      width: 97%;
      border: 1.2px solid #e0e0e0;
      transition: background 0.16s;
    }
    /* --- DARKER TYPE COLORS --- */
    .card-pdf {
      background: #ffe6b3;
      border-left: 6px solid #ff9800;
    }
    .card-audio {
      background: #fffde8;
      border-left: 6px solid #ffd600;
    }
    .card-video {
      background: #ffe1ee;
      border-left: 6px solid #e91e63;
    }
    .card-image {
      background: #e1f0ff;
      border-left: 6px solid #0288d1;
    }
    /* ... rest of your CSS remains unchanged ... */
  </style>
</head>
<body>
  <div id="app">
    <header>
      Railway Crew Resource Hub
    </header>
    <main>
      <aside>
        <h3>File Types</h3>
        <ul>
          <li :class="{active: selectedCategory === 'All'}" @click="selectCategory('All')">All</li>
          <li v-for="cat in categories" :key="cat"
              :class="{active: selectedCategory === cat}"
              @click="selectCategory(cat)">
            {{ cat.charAt(0).toUpperCase() + cat.slice(1) }}
          </li>
        </ul>
      </aside>
      <section>
        <div class="search-area">
          <form class="enhanced-search" @submit.prevent>
            <span class="search-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <circle cx="11" cy="11" r="7" stroke="#2e7d32" stroke-width="2"/>
                <path d="M20 20L17 17" stroke="#2e7d32" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </span>
            <input v-model="searchText" type="search" placeholder="Search files, descriptions, or types..." autocomplete="off" />
          </form>
        </div>
        <div v-if="filteredFiles.length === 0" style="margin:2rem auto; text-align:center; color:#8e9ea6; font-size:1.23em;">No files found.</div>
        <div v-for="file in filteredFiles" :key="file.file"
             class="card"
             :class="'card-' + file.type">
          <div class="thumbnail-container">
            <template v-if="file.type === 'pdf'">
              <img v-if="file.pdfThumbnail" :src="file.pdfThumbnail" alt="PDF Thumbnail" />
              <div v-else-if="file.loadingThumbnail" class="loading-thumbnail">Loading PDF...</div>
              <img v-else :src="file.thumbnail" alt="Default PDF Thumbnail" :class="{ 'thumbnail-loading': file.thumbnailGenerationStarted }" />
            </template>
            <img v-else :src="file.thumbnail" alt="Thumbnail" />
          </div>
          <div class="card-content">
            <h4 :title="file.title">{{ file.title }}</h4>
            <div class="actions">
              <button class="btn btn-view" @click="viewFile(file)">üëÅÔ∏è View</button>
              <button class="btn btn-download" @click="downloadFile(file)">üì• Download</button>
            </div>
          </div>
        </div>
      </section>
    </main>
    <!-- Modal and Vue app script as previously included, unchanged. -->
    <div v-if="viewingFile" class="modal-overlay" @click="closeModal">
      <div class="modal-content" @click.stop>
        <div class="modal-header">
          <span>{{ viewingFile.title }}</span>
          <button class="close-btn" @click="closeModal">&times;</button>
        </div>
        <div class="modal-body">
          <div v-if="viewingFile.type === 'pdf'" class="mobile-pdf-options">
            <h4>üì± Mobile PDF Viewing</h4>
            <p>Choose the best viewing method for your Android device:</p>
            <div class="option-card">
              <h5>üöÄ Instant Access <span class="recommended-badge">RECOMMENDED</span></h5>
              <p>
                Open directly in your device's default PDF app or browser. Works reliably on all Android browsers including Chrome and Opera GX.
              </p>
              <div class="button-group">
                <button class="btn btn-view" @click="openInNewTab(viewingFile.file)">
                  <svg viewBox="0 0 24 24"><path d="M14 3h7v7M10 14L21 3M21 21H3V3h7"/></svg>
                  Open in New Tab
                </button>
                <button class="btn btn-download" @click="downloadAndClose(viewingFile)">
                  <svg viewBox="0 0 24 24"><path d="M12 3v12m0 0l6-6m-6 6l-6-6m6 6v6"/></svg>
                  Download PDF
                </button>
              </div>
            </div>
            <div class="option-card">
              <h5>üîß Alternative Viewers</h5>
              <p>
                These may work but can fail on mobile browsers (like the face icon or error you experienced).
              </p>
              <div class="button-group">
                <button class="btn btn-view" @click="tryMozillaViewer">
                  <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="#FF9400" /><path d="M9 15l2.5-2 2.5 2" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  Mozilla PDF.js
                </button>
                <button class="btn btn-view" @click="tryDirectView">
                  <svg viewBox="0 0 24 24"><rect width="20" height="16" x="2" y="4" rx="3" stroke="#fff" stroke-width="1.5" fill="#4caf50"/></svg>
                  Direct Browser View
                </button>
              </div>
            </div>
            <div class="info-box">
              <strong>üì± Why Google Viewer Fails on Android:</strong>
              Google Docs Viewer has known issues with mobile browsers, especially Android Chrome and Opera GX. It frequently returns empty responses (204 errors) or shows placeholder icons instead of PDF content. This is a long-standing, unfixed issue with Google's service.
            </div>
          </div>
          <img v-else-if="viewingFile.type === 'image'" :src="viewingFile.file"
            :alt="viewingFile.title" class="modal-image" style="max-width:100%;border-radius:12px;display:block;margin:1em auto;"/>
          <video v-else-if="viewingFile.type === 'video'" :src="viewingFile.file" controls
            class="modal-video"></video>
          <audio v-else-if="viewingFile.type === 'audio'" :src="viewingFile.file" controls
            class="modal-audio"></audio>
        </div>
      </div>
    </div>
  </div>
  <script>
    const { createApp } = Vue;
    createApp({
      data() {
        return {
          files: [],
          selectedCategory: 'All',
          searchText: '',
          processedPdfs: new Set(),
          viewingFile: null
        };
      },
      computed: {
        categories() {
          return [...new Set(this.files.map(f => f.category))].sort();
        },
        filteredFiles() {
          const filtered = this.files.filter(f => {
            const matchCat = this.selectedCategory === 'All' || f.category === this.selectedCategory;
            const matchText = f.title.toLowerCase().includes(this.searchText.toLowerCase());
            return matchCat && matchText;
          });
          this.$nextTick(() => {
            filtered.forEach(file => {
              if (file.type === 'pdf' && 
                  !file.pdfThumbnail && 
                  !file.loadingThumbnail && 
                  !this.processedPdfs.has(file.file)) {
                this.loadPDFThumbnail(file);
              }
            });
          });
          return filtered;
        }
      },
      methods: {
        selectCategory(cat) {
          this.selectedCategory = cat;
        },
        async loadFiles() {
          try {
            const response = await fetch('data/docs.json');
            this.files = await response.json();
            this.files.forEach(file => {
              if (file.type === 'pdf') {
                this.$set(file, 'pdfThumbnail', null);
                this.$set(file, 'loadingThumbnail', false);
                this.$set(file, 'thumbnailGenerationStarted', false);
              }
            });
          } catch (err) {
            console.error('Could not load docs.json:', err);
          }
        },
        async loadPDFThumbnail(file) {
          if (file.type === 'pdf' && !file.pdfThumbnail && !file.loadingThumbnail && !this.processedPdfs.has(file.file)) {
            this.processedPdfs.add(file.file);
            file.loadingThumbnail = true;
            file.thumbnailGenerationStarted = true;
            try {
              const thumbnail = await generatePDFThumbnail(file.file);
              if (thumbnail) file.pdfThumbnail = thumbnail;
            } catch (error) { }
            file.loadingThumbnail = false;
          }
        },
        viewFile(file) {
          this.viewingFile = file;
          document.body.style.overflow = 'hidden';
        },
        openInNewTab(fileUrl) {
          window.open(fileUrl, '_blank');
        },
        tryMozillaViewer() {
          const fullUrl = new URL(this.viewingFile.file, window.location.origin).href;
          window.open(`https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(fullUrl)}`, '_blank');
        },
        tryDirectView() {
          window.open(this.viewingFile.file, '_blank');
        },
        downloadAndClose(file) {
          this.downloadFile(file);
          this.closeModal();
        },
        closeModal() {
          this.viewingFile = null;
          document.body.style.overflow = '';
        },
        async downloadFile(file) {
          try {
            const response = await fetch(file.file);
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const fileName = this.getFileName(file.file);
            const tempLink = document.createElement('a');
            tempLink.href = url;
            tempLink.download = fileName;
            tempLink.style.display = 'none';
            document.body.appendChild(tempLink);
            tempLink.click();
            document.body.removeChild(tempLink);
            window.URL.revokeObjectURL(url);
          } catch (error) {
            const tempLink = document.createElement('a');
            tempLink.href = file.file;
            tempLink.download = this.getFileName(file.file);
            tempLink.style.display = 'none';
            document.body.appendChild(tempLink);
            tempLink.click();
            document.body.removeChild(tempLink);
          }
        },
        getFileName(filePath) { return filePath.split('/').pop(); }
      },
      mounted() {
        this.loadFiles();
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.viewingFile) {
            this.closeModal();
          }
        });
      }
    }).mount('#app');
  </script>
</body>
</html>
