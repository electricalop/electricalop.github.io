<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Railway Crew Resource Hub</title>
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    window['pdfjs-dist/build/pdf'] = pdfjsLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>
  <script src="js/pdf-thumbnail.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #f5f7fa;
      color: #28303d;
    }
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    /* FIXED HEADER */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, #388e3c 0%, #43a047 100%);
      color: #fff;
      padding: 1.1rem;
      font-size: 1.2rem;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(70,150,100,0.15);
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 1rem;
      z-index: 1201;
      height: 60px;
      box-sizing: border-box;
    }
    
    /* FIXED SEARCH BAR */
    .search-area {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      background: #f5f7fa;
      padding: 1rem;
      border-bottom: 1px solid #e0e0e0;
      z-index: 1200;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    /* Burger menu icon */
    .burger-icon {
      width: 26px;
      height: 20px;
      cursor: pointer;
      display: none;
      flex-direction: column;
      justify-content: space-between;
    }
    .burger-icon div {
      height: 3.5px;
      background: white;
      border-radius: 2px;
    }
    
    @media (max-width: 799px) {
      .burger-icon {
        display: flex;
      }
      header {
        text-align: left;
      }
    }
    
    /* MAIN CONTENT WITH TOP MARGIN */
    main {
      flex: 1;
      display: flex;
      overflow: hidden;
      background: #f5f7fa;
      margin-top: 140px; /* Space for fixed header + search bar */
    }
    
    /* Desktop sidebar */
    aside.sidebar-desktop {
      width: 240px;
      background: #ffffff;
      border-right: 1.5px solid #e4e4e4;
      padding: 1rem;
      overflow-y: auto;
      flex-shrink: 0;
      display: block;
    }
    
    @media (max-width: 799px) {
      aside.sidebar-desktop {
        display: none;
      }
    }
    
    aside h3 {
      margin-top: 0;
      font-size: 1rem;
      font-weight: 700;
      color: #388e3c;
      letter-spacing: 0.5px;
      margin-bottom: 0.7em;
    }
    aside ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    aside li {
      margin: 9px 0;
      padding: 8px 12px;
      border-radius: 7px;
      cursor: pointer;
      color: #28303d;
      font-size: 1rem;
      font-weight: 500;
      transition: background-color 0.12s;
      user-select: none;
    }
    aside li:hover,
    aside li.active {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    /* Content section */
    section.content-area {
      flex: 1;
      min-width: 0;
      padding: 1rem 0.5em 2em 0.5em;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* Mobile side tray */
    .mobile-side-tray {
      position: fixed;
      top: 0; left: 0;
      width: 55vw;
      max-width: 300px;
      height: 100vh;
      background: white;
      box-shadow: 3px 0 20px rgba(0,0,0,0.15);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 1300;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      -webkit-overflow-scrolling: touch;
    }
    .mobile-side-tray.open {
      transform: translateX(0);
    }
    
    /* Mobile overlay */
    .mobile-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.3);
      z-index: 1299;
    }
    
    /* Mobile side tray elements */
    .mobile-side-tray h3 {
      margin-top: 0;
      font-size: 1.2rem;
      font-weight: 700;
      color: #388e3c;
      border-bottom: 1px solid #ddd;
      padding-bottom: 0.5rem;
      user-select: none;
    }
    .mobile-side-tray ul {
      list-style: none;
      padding: 0;
      margin: 1rem 0 0 0;
    }
    .mobile-side-tray li {
      padding: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      border-radius: 8px;
      color: #28303d;
      font-size: 1.1rem;
      font-weight: 600;
      user-select: none;
      transition: background-color 0.15s;
    }
    .mobile-side-tray li.active {
      background: #2e7d32;
      color: white;
    }
    .mobile-side-tray li:hover:not(.active) {
      background: #e8f5e9;
      color: #2e7d32;
    }

    /* Enhanced search styling */
    .enhanced-search {
      width: 100%;
      max-width: 410px;
      background: #fff;
      border-radius: 25px;
      box-shadow: 0 2px 8px rgba(46,125,50,0.08);
      border: 2px solid #c8e6c9;
      display: flex;
      align-items: center;
      overflow: hidden;
      transition: box-shadow 0.2s, border 0.2s;
    }
    .enhanced-search:focus-within {
      box-shadow: 0 4px 16px rgba(46,125,50,0.16);
      border-color: #2e7d32;
    }
    .enhanced-search input {
      border: none;
      outline: none;
      flex: 1;
      color: #28303d;
      background: transparent;
      font-size: 1.07em;
      padding: 14px 16px;
      font-family: inherit;
      transition: color 0.12s;
    }
    .enhanced-search input::placeholder {
      color: #a8b2bb;
    }
    .enhanced-search .search-icon {
      margin-left: 10px;
      margin-right: 9px;
      display: flex;
      align-items: center;
      color: #2e7d32;
      font-size: 1.27em;
    }

    /* Card styles with type coloring */
    .card {
      background: #fff;
      padding: 0.8rem 1.1rem;
      margin: 0 auto 1.2rem auto;
      border-radius: 18px;
      box-shadow: 0 2.5px 12px rgba(80,140,120,0.09);
      display: flex;
      align-items: center;
      gap: 19px;
      max-width: 650px;
      width: 97%;
      border: 1.2px solid #e0e0e0;
      transition: background 0.16s;
    }
    .card-pdf {
      background: #fff3e0;
      border-left: 5px solid #ff9800;
    }
    .card-audio {
      background: #fff9c4;
      border-left: 5px solid #fbc02d;
    }
    .card-video {
      background: #fce4ec;
      border-left: 5px solid #e91e63;
    }
    .card-image {
      background: #e3f2fd;
      border-left: 5px solid #0288d1;
    }
    .thumbnail-container {
      width: 74px;
      height: 74px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #ecf5ee;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #e0e0e0;
      flex-shrink: 0;
    }
    .thumbnail-loading {
      font-size: 13px;
      color: #888;
      text-align: center;
    }
    .card img {
      width: 74px;
      height: 74px;
      object-fit: cover;
      border-radius: 9px;
    }
    .card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .card h4 {
      margin: 0 0 8px 0;
      font-size: 1.09rem;
      color: #1b3e20;
      font-weight: 600;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
      max-width: 200px;
      letter-spacing: 0.1px;
    }
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .btn {
      padding: 9px 16px;
      border-radius: 7px;
      text-decoration: none;
      font-weight: 600;
      font-size: 13.7px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      letter-spacing: 0.05em;
      transition: box-shadow 0.13s, background 0.12s;
      box-shadow: 0 1.5px 3.5px 0 rgba(40,140,90,0.07);
      outline: none;
    }
    .btn-view {
      background-color: #2e7d32;
      color: #fff;
    }
    .btn-view:hover, .btn-view:focus {
      background-color: #207020;
      box-shadow: 0 2px 7px rgba(46,125,50,0.12);
    }
    .btn-download {
      background-color: #1976d2;
      color: #fff;
    }
    .btn-download:hover, .btn-download:focus {
      background-color: #155fc0;
      box-shadow: 0 2px 7px rgba(25,118,210,0.1);
    }
    .thumbnail-loading { opacity: 0.7; }
    
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(22, 31, 46, 0.55);
      z-index: 1400;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      overflow-y: auto;
      padding: 2vw 0.2rem;
      box-sizing: border-box;
    }
    .modal-content {
      background: #fff;
      border-radius: 17px;
      width: 99vw;
      max-width: 450px;
      min-width: 0;
      padding: 0;
      box-shadow: 0 6px 30px rgba(10,30,60,0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      margin-bottom: 2vw;
    }
    .modal-header {
      background: linear-gradient(90deg, #378e63 0%, #228940 100%);
      color: #fff;
      padding: 0.85em 1.1em;
      font-size: 1.02em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 17px 17px 0 0;
      font-weight: 600;
    }
    .modal-header button.close-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.8em;
      cursor: pointer;
      transition: color 0.1s;
    }
    .modal-header button.close-btn:hover,
    .modal-header button.close-btn:focus {
      color: #eafae6;
    }
    .modal-body {
      background: #f5f7fa;
      padding: 1.2em;
      overflow-y: auto;
      max-height: 70vh;
      min-height: 190px;
      -webkit-overflow-scrolling: touch;
    }
    .mobile-pdf-options h4 {
      font-size: 1.2em;
      font-weight: 700;
      color: #222;
      margin: 8px 0 2px 0;
    }
    .mobile-pdf-options > p {
      color: #466060;
      margin-bottom: 11px;
      font-size: 1em;
      margin-top: 0;
    }
    .option-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1.5px 7px rgba(30,120,60,0.05);
      border: 1.2px solid #dee7df;
      margin-bottom: 1.25rem;
      padding: 1rem 1rem 0.3rem 1rem;
    }
    .option-card:last-of-type { margin-bottom: 1rem; }
    .option-card h5 {
      margin: 0 0 0.6em 0;
      color: #347e54;
      font-size: 1em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .recommended-badge {
      display: inline-block;
      background: #43a047;
      color: #fff;
      font-size: 0.86em;
      padding: 2px 8px;
      border-radius: 9px;
      margin-left: 8px;
      letter-spacing: 1px;
      font-weight: 600;
      text-shadow: 0 1px 1px rgba(30,130,80,0.06);
    }
    .option-card p {
      color: #406664;
      margin: 0 0 0.7em 0;
      font-size: 0.98em;
      letter-spacing: 0.1px;
    }
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 3px;
    }
    .option-card .btn {
      min-width: 140px;
      padding: 8px 0;
      font-size: 0.99em;
      flex: 1 1 auto;
    }
    .option-card .btn-view {
      background: #43a047;
      color: #fff !important;
    }
    .option-card .btn-view:hover, .option-card .btn-view:focus {
      background: #228940;
      color: #fff !important;
    }
    .option-card .btn-download {
      background: #1976d2;
      color: #fff !important;
    }
    .option-card .btn-download:hover, .option-card .btn-download:focus {
      background: #125abe;
      color: #fff !important;
    }
    .option-card .btn-view svg,
    .option-card .btn-download svg {
      vertical-align: middle;
      margin-right: 4px;
      margin-bottom: 2px;
      width: 1.15em;
      height: 1.1em;
      fill: currentColor;
    }
    .info-box {
      background: #e9f5fb;
      border: 1.3px solid #2087ac;
      color: #1565c0;
      padding: 0.9rem 1em 0.8rem 1em;
      border-radius: 10px;
      font-size: 0.98em;
      margin: 0.7rem 0 0 0;
      font-weight: 500;
    }
    .info-box strong {
      display: block;
      margin-bottom: 5px;
      color: #186a33;
    }
    
    @media (max-width: 540px) {
      .modal-content, .card { max-width: 99vw; border-radius: 13px;}
      .modal-body { padding: 11px 5px; }
      .mobile-pdf-options { padding: 7px; }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- FIXED HEADER -->
    <header>
      <div class="burger-icon" @click="sideMenuOpen = true">
        <div></div>
        <div></div>
        <div></div>
      </div>
      Railway Crew Resource Hub
    </header>
    
    <!-- FIXED SEARCH BAR -->
    <div class="search-area">
      <form class="enhanced-search" @submit.prevent>
        <span class="search-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <circle cx="11" cy="11" r="7" stroke="#2e7d32" stroke-width="2"/>
            <path d="M20 20L17 17" stroke="#2e7d32" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </span>
        <input v-model="searchText" type="search" placeholder="Search files, descriptions, or types..." autocomplete="off" />
      </form>
    </div>
    
    <main>
      <!-- Desktop sidebar -->
      <aside class="sidebar-desktop">
        <h3>File Types</h3>
        <ul>
          <li :class="{ active: selectedCategory === 'All' }" @click="selectCategory('All')">All</li>
          <li v-for="cat in categories" :key="cat" :class="{ active: selectedCategory === cat }" @click="selectCategory(cat)">
            {{ cat.charAt(0).toUpperCase() + cat.slice(1) }}
          </li>
        </ul>
      </aside>

      <!-- Content area -->
      <section class="content-area">
        <!-- Files list -->
        <div v-if="filteredFiles.length === 0" style="margin:2rem auto; text-align:center; color:#8e9ea6; font-size:1.23em;">
          No files found.
        </div>
        <div v-for="file in filteredFiles" :key="file.file" :class="['card', 'card-' + file.type]">
          <div class="thumbnail-container">
            <template v-if="file.type === 'pdf'">
              <img v-if="file.pdfThumbnail" :src="file.pdfThumbnail" alt="PDF Thumbnail" />
              <div v-else-if="file.loadingThumbnail" class="loading-thumbnail">Loading PDF...</div>
              <img v-else :src="file.thumbnail" alt="Default PDF Thumbnail" :class="{ 'thumbnail-loading': file.thumbnailGenerationStarted }" />
            </template>
            <img v-else :src="file.thumbnail" alt="Thumbnail" />
          </div>
          <div class="card-content">
            <h4 :title="file.title">{{ file.title }}</h4>
            <div class="actions">
              <button class="btn btn-view" @click="viewFile(file)">üëÅÔ∏è View</button>
              <button class="btn btn-download" @click="downloadFile(file)">üì• Download</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Mobile side menu overlay and tray -->
    <div v-if="sideMenuOpen" class="mobile-overlay" @click="sideMenuOpen = false"></div>
    <nav :class="['mobile-side-tray', {open: sideMenuOpen}]">
      <h3>File Types</h3>
      <ul>
        <li :class="{ active: selectedCategory === 'All' }" @click="selectCategory('All'); sideMenuOpen = false">All</li>
        <li v-for="cat in categories" :key="cat" :class="{ active: selectedCategory === cat }" @click="selectCategory(cat); sideMenuOpen = false">
          {{ cat.charAt(0).toUpperCase() + cat.slice(1) }}
        </li>
      </ul>
    </nav>

    <!-- Modal -->
    <div v-if="viewingFile" class="modal-overlay" @click="closeModal">
      <div class="modal-content" @click.stop>
        <div class="modal-header">
          <span>{{ viewingFile.title }}</span>
          <button class="close-btn" @click="closeModal">&times;</button>
        </div>
        <div class="modal-body">
          <div v-if="viewingFile.type === 'pdf'" class="mobile-pdf-options">
            <h4>üì± Mobile PDF Viewing</h4>
            <p>Choose the best viewing method for your Android device:</p>
            <div class="option-card">
              <h5>üöÄ Instant Access <span class="recommended-badge">RECOMMENDED</span></h5>
              <p>
                Open directly in your device's default PDF app or browser. Works reliably on all Android browsers including Chrome and Opera GX.
              </p>
              <div class="button-group">
                <button class="btn btn-view" @click="openInNewTab(viewingFile.file)">
                  <svg viewBox="0 0 24 24"><path d="M14 3h7v7M10 14L21 3M21 21H3V3h7"/></svg>
                  Open in New Tab
                </button>
                <button class="btn btn-download" @click="downloadAndClose(viewingFile)">
                  <svg viewBox="0 0 24 24"><path d="M12 3v12m0 0l6-6m-6 6l-6-6m6 6v6"/></svg>
                  Download PDF
                </button>
              </div>
            </div>
            <div class="option-card">
              <h5>üîß Alternative Viewers</h5>
              <p>
                These may work but can fail on mobile browsers (like the face icon or error you experienced).
              </p>
              <div class="button-group">
                <button class="btn btn-view" @click="tryMozillaViewer">
                  <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="#FF9400" /><path d="M9 15l2.5-2 2.5 2" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  Mozilla PDF.js
                </button>
                <button class="btn btn-view" @click="tryDirectView">
                  <svg viewBox="0 0 24 24"><rect width="20" height="16" x="2" y="4" rx="3" stroke="#fff" stroke-width="1.5" fill="#4caf50"/></svg>
                  Direct Browser View
                </button>
              </div>
            </div>
            <div class="info-box">
              <strong>üì± Why Google Viewer Fails on Android:</strong>
              Google Docs Viewer has known issues with mobile browsers, especially Android Chrome and Opera GX. It frequently returns empty responses (204 errors) or shows placeholder icons instead of PDF content. This is a long-standing, unfixed issue with Google's service.
            </div>
          </div>
          <img v-else-if="viewingFile.type === 'image'" :src="viewingFile.file"
            :alt="viewingFile.title" class="modal-image" style="max-width:100%;border-radius:12px;display:block;margin:1em auto;"/>
          <video v-else-if="viewingFile.type === 'video'" :src="viewingFile.file" controls
            class="modal-video"></video>
          <audio v-else-if="viewingFile.type === 'audio'" :src="viewingFile.file" controls
            class="modal-audio"></audio>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    const { createApp } = Vue;
    createApp({
      data() {
        return {
          files: [],
          selectedCategory: 'All',
          searchText: '',
          processedPdfs: new Set(),
          viewingFile: null,
          sideMenuOpen: false
        };
      },
      computed: {
        categories() {
          return [...new Set(this.files.map(f => f.category))].sort();
        },
        filteredFiles() {
          const filtered = this.files.filter(f => {
            const matchCat = this.selectedCategory === 'All' || f.category === this.selectedCategory;
            const matchText = f.title.toLowerCase().includes(this.searchText.toLowerCase());
            return matchCat && matchText;
          });
          this.$nextTick(() => {
            filtered.forEach(file => {
              if (file.type === 'pdf' && 
                  !file.pdfThumbnail && 
                  !file.loadingThumbnail && 
                  !this.processedPdfs.has(file.file)) {
                this.loadPDFThumbnail(file);
              }
            });
          });
          return filtered;
        }
      },
      methods: {
        selectCategory(cat) {
          this.selectedCategory = cat;
        },
        async loadFiles() {
          try {
            const response = await fetch('data/docs.json');
            this.files = await response.json();
            this.files.forEach(file => {
              if (file.type === 'pdf') {
                this.$set(file, 'pdfThumbnail', null);
                this.$set(file, 'loadingThumbnail', false);
                this.$set(file, 'thumbnailGenerationStarted', false);
              }
            });
          } catch (err) {
            console.error('Could not load docs.json:', err);
          }
        },
        async loadPDFThumbnail(file) {
          if (file.type === 'pdf' && !file.pdfThumbnail && !file.loadingThumbnail && !this.processedPdfs.has(file.file)) {
            this.processedPdfs.add(file.file);
            file.loadingThumbnail = true;
            file.thumbnailGenerationStarted = true;
            try {
              const thumbnail = await generatePDFThumbnail(file.file);
              if (thumbnail) file.pdfThumbnail = thumbnail;
            } catch (error) { }
            file.loadingThumbnail = false;
          }
        },
        viewFile(file) {
          this.viewingFile = file;
          document.body.style.overflow = 'hidden';
        },
        openInNewTab(fileUrl) {
          window.open(fileUrl, '_blank');
        },
        tryMozillaViewer() {
          const fullUrl = new URL(this.viewingFile.file, window.location.origin).href;
          window.open(`https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(fullUrl)}`, '_blank');
        },
        tryDirectView() {
          window.open(this.viewingFile.file, '_blank');
        },
        downloadAndClose(file) {
          this.downloadFile(file);
          this.closeModal();
        },
        closeModal() {
          this.viewingFile = null;
          document.body.style.overflow = '';
        },
        async downloadFile(file) {
          try {
            const response = await fetch(file.file);
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const fileName = this.getFileName(file.file);
            const tempLink = document.createElement('a');
            tempLink.href = url;
            tempLink.download = fileName;
            tempLink.style.display = 'none';
            document.body.appendChild(tempLink);
            tempLink.click();
            document.body.removeChild(tempLink);
            window.URL.revokeObjectURL(url);
          } catch (error) {
            const tempLink = document.createElement('a');
            tempLink.href = file.file;
            tempLink.download = this.getFileName(file.file);
            tempLink.style.display = 'none';
            document.body.appendChild(tempLink);
            tempLink.click();
            document.body.removeChild(tempLink);
          }
        },
        getFileName(filePath) { return filePath.split('/').pop(); }
      },
      mounted() {
        this.loadFiles();
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.viewingFile) {
            this.closeModal();
          }
          if (e.key === 'Escape' && this.sideMenuOpen) {
            this.sideMenuOpen = false;
          }
        });
      }
    }).mount('#app');
  </script>
</body>
</html>
